// Prisma Schema para Portal da Locadora
// Sistema de Gestão para Locadoras focadas em Motoristas de App

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENTIDADES BASE (FASE 1)
// ============================================

// Usuários do sistema (atendentes, gerentes, admin, etc.)
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // Hash bcrypt
  name      String
  role      Role     @default(ATENDENTE)
  active    Boolean  @default(true)
  filialId  String?  // Null = acesso a todas as filiais (admin)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  filial            Filial?             @relation(fields: [filialId], references: [id])
  auditLogs         AuditLog[]          // Logs de auditoria gerados pelo usuário
  contratoTemplates ContratoTemplate[]  // Templates de contrato criados

  @@map("users")
}

// Perfis de acesso (RBAC)
enum Role {
  ADMIN              // Admin do sistema
  DIRETORIA          // Diretoria/BI
  FINANCEIRO         // Financeiro
  GESTOR_FROTA       // Gestor de frota
  GERENTE_LOJA       // Gerente de loja
  ATENDENTE          // Atendente de balcão
  EQUIPE_EXTERNA     // Vistoria/retomada/entregas
}

// Filiais/Lojas
model Filial {
  id        String   @id @default(uuid())
  name      String
  cnpj      String   @unique
  phone     String?
  email     String?
  active    Boolean  @default(true)
  
  // Endereço
  address   String
  city      String
  state     String   // UF
  zipCode   String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  veiculos  Veiculo[]
  contratos Contrato[]

  @@map("filiais")
}

// ============================================
// ENTIDADES DE DOMÍNIO (FASE 2)
// ============================================

// Motoristas (clientes que alugam veículos)
model Motorista {
  id            String   @id @default(uuid())
  name          String
  email         String?  @unique
  phone         String
  cpf           String?  @unique
  cnpj          String?  @unique
  rg            String?
  cnh           String   @unique
  cnhCategory   String   // A, B, AB, etc.
  cnhExpiry     DateTime
  
  // Endereço
  address       String?
  city          String?
  state         String?
  zipCode       String?
  
  // Dados bancários (para débito automático)
  bankName      String?
  bankAgency    String?
  bankAccount   String?
  
  // Controle
  active        Boolean  @default(true)
  blacklisted   Boolean  @default(false) // Bloqueado por inadimplência/sinistro
  blacklistReason String?
  
  // Documentos digitalizados
  cnhPhoto      String?  // URL do arquivo
  rgPhoto       String?
  compResidencia String? // Comprovante de residência
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  contratos     Contrato[]
  documentos    DocumentoDigital[]

  @@map("motoristas")
}

// Veículos (frota disponível)
model Veiculo {
  id            String   @id @default(uuid())
  plate         String   @unique // Placa
  renavam       String?  @unique
  chassi        String?  @unique
  
  // Identificação
  brand         String   // Marca (Fiat, VW, etc.)
  model         String   // Modelo (Argo, Gol, etc.)
  year          Int      // Ano modelo
  color         String
  category      VehicleCategory @default(HATCH)
  
  // Especificações
  fuelType      FuelType @default(FLEX)
  transmission  Transmission @default(MANUAL)
  doors         Int      @default(4)
  
  // Controle
  filialId      String
  status        VehicleStatus @default(DISPONIVEL)
  km            Int      @default(0) // Quilometragem atual
  
  // Valores
  fipeValue     Decimal? @db.Decimal(10, 2) // Valor FIPE
  
  // Manutenção
  lastMaintenance    DateTime?
  nextMaintenance    DateTime?
  nextMaintenanceKm  Int? // Próxima manutenção preventiva em km
  
  // Documentação
  crlvPhoto     String?  // CRLV digitalizado
  
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  filial        Filial   @relation(fields: [filialId], references: [id])
  contratos     Contrato[]
  manutencoes   Manutencao[]
  documentos    DocumentoDigital[]
  historicoKm   HistoricoKm[]

  @@map("veiculos")
}

// Histórico de KM semanal do veículo
model HistoricoKm {
  id            String   @id @default(uuid())
  veiculoId     String
  contratoId    String?  // Contrato ativo quando registrado
  kmAtual       Int      // KM atual registrado
  kmAnterior    Int      // KM da semana anterior
  kmRodado      Int      // Diferença calculada (kmAtual - kmAnterior)
  dataRegistro  DateTime @default(now()) // Data do registro
  registradoPor String?  // ID do usuário que registrou
  observacao    String?  // Observações opcionais
  
  veiculo       Veiculo  @relation(fields: [veiculoId], references: [id], onDelete: Cascade)
  contrato      Contrato? @relation(fields: [contratoId], references: [id])
  
  @@map("historico_km")
  @@index([veiculoId])
  @@index([contratoId])
  @@index([dataRegistro])
}

enum VehicleCategory {
  HATCH          // Hatch popular
  SEDAN          // Sedan
  SUV            // SUV/Crossover
  PICAPE         // Picape
  VAN            // Van/Utilitário
}

enum FuelType {
  FLEX           // Flex (etanol/gasolina)
  GASOLINA       // Gasolina
  DIESEL         // Diesel
  ELETRICO       // Elétrico
  HIBRIDO        // Híbrido
}

enum Transmission {
  MANUAL         // Manual
  AUTOMATICO     // Automático
  AUTOMATIZADO   // Automatizado (AMT)
}

enum VehicleStatus {
  DISPONIVEL     // Disponível para locação
  LOCADO         // Locado atualmente
  MANUTENCAO     // Em manutenção
  VISTORIA       // Aguardando vistoria
  INATIVO        // Inativo (vendido, sinistrado, etc.)
}

// Planos de locação (produtos oferecidos)
model Plano {
  id            String   @id @default(uuid())
  name          String   // Ex: "Plano Uber Mensal", "Plano 99 Semanal"
  description   String?
  
  // Valores
  dailyPrice    Decimal  @db.Decimal(10, 2) // Diária
  weeklyPrice   Decimal? @db.Decimal(10, 2) // Semanal
  monthlyPrice  Decimal  @db.Decimal(10, 2) // Mensal
  
  // Incluso no plano
  kmIncluded    Int?     // KM inclusos (null = ilimitado)
  kmExtraPrice  Decimal? @db.Decimal(10, 2) // Valor por KM excedente
  
  // Benefícios
  includesInsurance Boolean @default(false) // Inclui seguro
  includesMaintenance Boolean @default(true) // Inclui manutenção
  
  // Categorias aceitas neste plano
  allowedCategories VehicleCategory[]
  
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  contratos     Contrato[]

  @@map("planos")
}

// Contratos de locação
model Contrato {
  id            String   @id @default(uuid())
  contractNumber String  @unique // Número do contrato (ex: 2025-001)
  
  // Relacionamentos
  motoristaId   String
  veiculoId     String
  planoId       String
  filialId      String
  
  // Período
  startDate     DateTime
  endDate       DateTime
  billingDay    Int      // Dia do vencimento (1-31)
  
  // Valores
  monthlyAmount Decimal  @db.Decimal(10, 2) // Valor mensal acordado
  deposit       Decimal? @db.Decimal(10, 2) // Caução
  
  // Quilometragem
  kmStart       Int      // KM inicial
  kmCurrent     Int?     // KM atual (atualizado periodicamente)
  
  // Status
  status        ContractStatus @default(ATIVO)
  
  // Observações
  notes         String?
  
  // Datas de controle
  signedAt      DateTime?
  canceledAt    DateTime?
  cancelReason  String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  motorista     Motorista @relation(fields: [motoristaId], references: [id])
  veiculo       Veiculo   @relation(fields: [veiculoId], references: [id])
  plano         Plano     @relation(fields: [planoId], references: [id])
  filial        Filial    @relation(fields: [filialId], references: [id])
  cobrancas     Cobranca[]
  documentos    DocumentoDigital[]
  historicoKm   HistoricoKm[]

  @@map("contratos")
}

enum ContractStatus {
  ANALISE        // Em análise (aguardando ativação)
  ATIVO          // Ativo
  SUSPENSO       // Suspenso (inadimplência temporária)
  CANCELADO      // Cancelado
  CONCLUIDO      // Concluído (fim do período)
}

// Cobranças mensais dos contratos
model Cobranca {
  id            String   @id @default(uuid())
  contratoId    String
  
  // Dados da cobrança
  referenceMonth String  // Mês de referência (YYYY-MM)
  dueDate       DateTime // Data de vencimento
  amount        Decimal  @db.Decimal(10, 2) // Valor da cobrança
  
  // Status do pagamento
  status        PaymentStatus @default(PENDENTE)
  paymentDate   DateTime?
  paymentMethod String?  // PIX, TED, Dinheiro, Cartão, etc.
  
  // Controle de inadimplência
  daysLate      Int      @default(0) // Dias de atraso
  lateFee       Decimal? @db.Decimal(10, 2) // Multa por atraso
  
  // Observações
  observations  String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  contrato      Contrato @relation(fields: [contratoId], references: [id])

  @@unique([contratoId, referenceMonth]) // Evita duplicatas
  @@map("cobrancas")
}

enum PaymentStatus {
  PENDENTE       // Aguardando pagamento
  PAGA           // Paga
  ATRASADA       // Atrasada (vencimento passou)
  CANCELADA      // Cancelada
}

// Manutenções dos veículos
model Manutencao {
  id            String   @id @default(uuid())
  veiculoId     String
  
  // Dados da manutenção
  type          MaintenanceType
  description   String   // Descrição do serviço
  date          DateTime // Data da manutenção
  mileage       Int      // Quilometragem no momento da manutenção
  
  // Valores e fornecedor
  cost          Decimal  @db.Decimal(10, 2) // Custo da manutenção
  provider      String   // Oficina/fornecedor
  
  // Status
  status        MaintenanceStatus @default(AGENDADA)
  
  // Observações
  observations  String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  veiculo       Veiculo  @relation(fields: [veiculoId], references: [id], onDelete: Cascade)

  @@map("manutencoes")
}

enum MaintenanceType {
  PREVENTIVA     // Manutenção preventiva
  CORRETIVA      // Manutenção corretiva
  REVISAO        // Revisão periódica
}

enum MaintenanceStatus {
  AGENDADA       // Agendada
  EM_ANDAMENTO   // Em andamento
  CONCLUIDA      // Concluída
  CANCELADA      // Cancelada
}

// ============================================
// AUDIT LOG (RASTREAMENTO DE ALTERAÇÕES)
// ============================================

model AuditLog {
  id        String   @id @default(uuid())
  entity    String   // Nome da entidade (Contrato, Veiculo, Motorista, etc)
  entityId  String   // ID do registro alterado
  action    AuditAction // CREATE, UPDATE, DELETE
  userId    String?  // Usuário que fez a alteração (null = sistema)
  userName  String?  // Nome do usuário no momento da ação
  changes   Json?    // Diff das alterações (before/after)
  timestamp DateTime @default(now())
  
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([entity, entityId])
  @@index([userId])
  @@index([timestamp])
  @@map("audit_logs")
}

// ============================================
// DOCUMENTOS DIGITALIZADOS (FASE 5)
// ============================================

// Documentos digitalizados (CNH, CRLV, contratos, laudos, etc)
model DocumentoDigital {
  id            String   @id @default(uuid())
  tipo          TipoDocumento
  nomeArquivo   String
  nomeOriginal  String
  tamanho       Int      // Tamanho em bytes
  mimeType      String
  url           String   // Caminho do arquivo ou URL (S3, local, etc)
  
  // Relacionamentos polimórficos (apenas um deve estar preenchido)
  motoristaId   String?
  veiculoId     String?
  contratoId    String?
  
  // Auditoria
  uploadedBy    String?  // ID do usuário que fez upload
  uploadedAt    DateTime @default(now())
  
  // Relacionamentos
  motorista     Motorista? @relation(fields: [motoristaId], references: [id], onDelete: Cascade)
  veiculo       Veiculo?   @relation(fields: [veiculoId], references: [id], onDelete: Cascade)
  contrato      Contrato?  @relation(fields: [contratoId], references: [id], onDelete: Cascade)
  
  @@index([motoristaId])
  @@index([veiculoId])
  @@index([contratoId])
  @@index([tipo])
  @@map("documentos_digitais")
}

enum TipoDocumento {
  CNH                  // Carteira Nacional de Habilitação
  RG                   // Registro Geral
  CPF                  // Cadastro de Pessoa Física
  FOTO_PERFIL          // Foto de Perfil do Motorista
  COMPROVANTE_RESIDENCIA
  COMPROVANTE_RENDA
  CRLV                 // Certificado de Registro e Licenciamento de Veículo
  LAUDO_VISTORIA
  CONTRATO_ASSINADO
  FOTO_VEICULO
  OUTROS
}

// Templates de Contrato
model ContratoTemplate {
  id        String   @id @default(uuid())
  titulo    String
  conteudo  String   @db.Text
  ativo     Boolean  @default(false)
  createdBy String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [createdBy], references: [id])

  @@map("contrato_templates")
}

// ============================================
// ENUMS
// ============================================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}
